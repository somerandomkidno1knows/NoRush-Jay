<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>gn-math — Playable (single file)</title>

  <!-- Inline style (from style.css) -->
  <style>
    :root {
      --primary-color: #5D5CDE;
      --text-color: #333;
      --background-color: #FFFFFF;
      --card-bg: #f8f8f8;
      --card-border: #e0e0e0;
      --shadow: rgba(0, 0, 0, 0.1);
      --popup-bg: #fff;
    }
    .dark-mode {
      --primary-color: #6e6df0;
      --text-color: #e0e0e0;
      --background-color: #181818;
      --card-bg: #252525;
      --card-border: #383838;
      --shadow: rgba(0, 0, 0, 0.4);
      --popup-bg: #252525;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    header {
      background-color: var(--primary-color);
      color: white;
      padding: 1rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px var(--shadow);
    }
    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
    }
    .logo { font-size: 1.5rem; font-weight: bold; }
    .search-container { display: flex; gap: 10px; margin: 0.5rem 0; }
    #searchBar { padding: 0.5rem; border-radius: 4px; border: 1px solid var(--card-border); flex-grow: 1; min-width: 0; font-size: 16px; }
    #sortOptions { padding: 0.5rem; border-radius: 4px; border: 1px solid var(--card-border); font-size: 16px; }
    .control-buttons { display: flex; gap: 10px; }
    #settings { background-color: transparent; border: none; color: white; font-size: 1.2rem; cursor: pointer; }
    main { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    #container { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; margin-top: 1rem; }
    .zone-item { background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: 8px; overflow: hidden; cursor: pointer; box-shadow: 0 2px 4px var(--shadow); display: flex; flex-direction: column; }
    .zone-item:hover { background-color: var(--card-border); }
    .zone-item img { width: 100%; aspect-ratio: 1; object-fit: cover; }
    .zone-item button { background-color: var(--card-bg); color: var(--text-color); border: none; padding: 10px; cursor: pointer; font-weight: bold; flex-grow: 1; height: 60px; display: flex; align-items: center; justify-content: center; text-align: center; }
    #zoneViewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--background-color); z-index: 1000; display: none; flex-direction: column; }
    .zone-header { display: flex; align-items: center; justify-content: space-between; background-color: var(--primary-color); color: white; padding: 0.5rem 1rem; }
    .zone-title { flex-grow: 1; display: flex; flex-direction: column; }
    #zoneName { font-size: 1.2rem; font-weight: bold; margin: 0; }
    #zoneId { display: none; }
    #zoneAuthor { font-size: 0.9rem; color: rgba(255, 255, 255, 0.8); text-decoration: none; }
    .zone-controls { display: flex; gap: 10px; }
    .zone-controls button { background-color: transparent; border: 1px solid white; color: white; padding: 0.5rem; border-radius: 4px; cursor: pointer; font-size: 14px; }
    .zone-controls button:hover { background-color: rgba(255, 255, 255, 0.1); }
    #zoneFrame { flex-grow: 1; border: none; width: 100%; height: 100%; }
    #popupOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .popup { background-color: var(--popup-bg); border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); width: 90%; max-width: 500px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
    .popup-header { background-color: var(--primary-color); color: white; padding: 0.8rem 1rem; display: flex; justify-content: space-between; align-items: center; }
    #popupTitle { margin: 0; font-size: 1.2rem; }
    #popupClose { background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer; line-height: 1; }
    #popupBody { padding: 1rem; overflow-y: auto; color: var(--text-color); }
    #popupBody input[type="text"], #popupBody input[type="file"] { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border: 1px solid var(--card-border); border-radius: 4px; background-color: var(--card-bg); color: var(--text-color); font-size: 16px; }
    #settings-button { display: block; width: 100%; padding: 0.75rem; background-color: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-bottom: 1rem; }
    footer { background-color: var(--card-bg); padding: 1rem; text-align: center; margin-top: 2rem; border-top: 1px solid var(--card-border); }
    .footer-links { display: flex; justify-content: center; gap: 20px; }
    .footer-links a { color: var(--primary-color); text-decoration: none; }
    .footer-links a:hover { text-decoration: underline; }
    #zoneCount { margin: 0.5rem 0; font-size: 0.9rem; color: var(--text-color); }
    @media (max-width: 768px) {
      .header-content { flex-direction: column; gap: 10px; }
      .search-container { width: 100%; }
      #container { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
      .zone-item img { height: 140px; }
      .zone-item button { height: 60px; font-size: 14px; }
    }
  </style>

  <!-- Keep external gnmath.js for compatibility (games may rely on it), loaded from original CDN -->
  <script src="https://cdn.jsdelivr.net/gh/gn-math/gn-math.github.io@main/gnmath.js"></script>
</head>
<body class="dark-mode">
  <header>
    <div class="header-content">
      <div class="logo">gn-math</div>
      <div class="search-container">
        <input type="text" id="searchBar" placeholder="Search games..." oninput="filterZones()">
        <select id="sortOptions" onchange="sortZones()">
          <option value="popular">Popular</option>
          <option value="name">Name</option>
          <option value="id">ID</option>
        </select>
      </div>
      <div class="control-buttons">
        <button id="settings" title="Settings">Settings</button>
      </div>
    </div>
  </header>

  <main>
    <div id="zoneCount">Loading games...</div>
    <div id="container">Loading...</div>
  </main>

  <div id="zoneViewer">
    <div class="zone-header">
      <div class="zone-title">
        <h2 id="zoneName">Game</h2>
        <span id="zoneId" style="display:none"></span>
        <a id="zoneAuthor" href="#" target="_blank">by Author</a>
      </div>
      <div class="zone-controls">
        <button onclick="fullscreenZone()">Fullscreen</button>
        <button onclick="aboutBlank()">Open in New Tab</button>
        <button onclick="downloadZone()">Download</button>
        <button onclick="closeZone()">Close</button>
      </div>
    </div>
    <iframe id="zoneFrame"></iframe>
  </div>

  <div id="popupOverlay">
    <div class="popup">
      <div class="popup-header">
        <h3 id="popupTitle">Title</h3>
        <button id="popupClose" onclick="closePopup()">×</button>
      </div>
      <div id="popupBody">Content will be here</div>
    </div>
  </div>

  <footer>
    <div class="footer-links">
      <a href="#" onclick="showContact(); return false;">Contact</a>
      <a href="#" onclick="loadPrivacy(); return false;">Privacy Policy</a>
      <a href="javascript:saveData()">Export Data</a>
      <label for="importData" style="color: var(--primary-color); cursor: pointer;">Import Data</label>
      <input type="file" id="importData" style="display: none;" onchange="loadData(event)">
    </div>
  </footer>

  <!-- Inline launcher script (from script.js) -->
  <script>
    // Config: these point to the original CDN used by the site.
    const zonesURL = "https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json";
    const coverURL = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
    const htmlURL = "https://cdn.jsdelivr.net/gh/gn-math/html@main";

    const container = document.getElementById('container');
    const zoneViewer = document.getElementById('zoneViewer');
    let zoneFrame = document.getElementById('zoneFrame');
    const searchBar = document.getElementById('searchBar');
    const sortOptions = document.getElementById('sortOptions');
    let zones = [];
    let popularityData = {};

    async function listZones() {
      try {
        const response = await fetch(zonesURL + "?t=" + Date.now());
        if (!response.ok) throw new Error(response.status + " " + response.statusText);
        const json = await response.json();
        zones = json;
        await fetchPopularity();
        sortZones();
        // If URL contains ?id=123 open that game
        const search = new URLSearchParams(window.location.search);
        const id = search.get('id');
        if (id) {
          const zone = zones.find(z => String(z.id) === String(id));
          if (zone) openZone(zone);
        }
      } catch (error) {
        container.innerHTML = "Error loading games: " + error;
        console.error(error);
      }
    }

    async function fetchPopularity() {
      try {
        const response = await fetch("https://data.jsdelivr.com/v1/stats/packages/gh/gn-math/html@main/files?period=year");
        const data = await response.json();
        data.forEach(file => {
          const idMatch = file.name.match(/\/(\d+)\.html$/);
          if (idMatch) {
            const id = parseInt(idMatch[1]);
            popularityData[id] = file.hits.total;
          }
        });
      } catch (err) {
        popularityData[0] = 0;
      }
    }

    function sortZones() {
      const sortBy = sortOptions.value;
      if (sortBy === 'name') zones.sort((a, b) => a.name.localeCompare(b.name));
      else if (sortBy === 'id') zones.sort((a, b) => a.id - b.id);
      else if (sortBy === 'popular') zones.sort((a, b) => (popularityData[b.id] || 0) - (popularityData[a.id] || 0));
      zones.sort((a, b) => (a.id === -1 ? -1 : b.id === -1 ? 1 : 0));
      displayZones(zones);
    }

    function displayZones(list) {
      container.innerHTML = "";
      list.forEach(file => {
        const zoneItem = document.createElement("div");
        zoneItem.className = "zone-item";
        zoneItem.onclick = () => openZone(file);

        const img = document.createElement("img");
        img.src = file.cover.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        img.alt = file.name;
        zoneItem.appendChild(img);

        const button = document.createElement("button");
        button.textContent = file.name;
        button.onclick = (ev) => { ev.stopPropagation(); openZone(file); };
        zoneItem.appendChild(button);

        container.appendChild(zoneItem);
      });

      if (container.innerHTML === "") container.innerHTML = "No zones found.";
      else document.getElementById("zoneCount").textContent = `Zones Loaded: ${list.length}`;
    }

    function filterZones() {
      const q = (searchBar.value || "").toLowerCase();
      const filtered = zones.filter(z => (z.name || "").toLowerCase().includes(q));
      displayZones(filtered);
    }

    async function openZone(file) {
      try {
        if (!file) return;
        if (file.url && file.url.startsWith("http")) {
          window.open(file.url, "_blank");
          return;
        }
        const url = file.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        const response = await fetch(url + "?t=" + Date.now());
        if (!response.ok) throw new Error(response.status + " " + response.statusText);
        const html = await response.text();

        // Ensure there's an iframe to write into
        if (!zoneFrame || !zoneViewer.contains(zoneFrame)) {
          zoneFrame = document.createElement("iframe");
          zoneFrame.id = "zoneFrame";
          zoneViewer.appendChild(zoneFrame);
        }
        // Write HTML into iframe
        try {
          const doc = zoneFrame.contentDocument || zoneFrame.contentWindow.document;
          doc.open();
          doc.write(html);
          doc.close();
        } catch (e) {
          // If cross-origin issues, open in new tab as fallback
          console.warn("Could not write into iframe (cross-origin?), opening in new tab.", e);
          const w = window.open();
          w.document.open();
          w.document.write(html);
          w.document.close();
        }

        document.getElementById('zoneName').textContent = file.name || "Game";
        document.getElementById('zoneId').textContent = file.id || "";
        document.getElementById('zoneAuthor').textContent = (file.author ? "by " + file.author : "");
        if (file.authorLink) document.getElementById('zoneAuthor').href = file.authorLink;
        zoneViewer.style.display = "flex";
      } catch (err) {
        alert("Failed to load game: " + err);
        console.error(err);
      }
    }

    function closeZone() {
      zoneViewer.style.display = "none";
      if (zoneFrame && zoneViewer.contains(zoneFrame)) zoneViewer.removeChild(zoneFrame);
      // recreate clean iframe for next open
      zoneFrame = document.createElement("iframe");
      zoneFrame.id = "zoneFrame";
    }

    function aboutBlank() {
      try {
        const id = document.getElementById('zoneId').textContent;
        const zone = zones.find(z => String(z.id) === String(id));
        if (!zone) { alert("No game selected."); return; }
        const url = zone.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        window.open(url + "?t=" + Date.now(), "_blank");
      } catch (e) { console.error(e); }
    }

    async function downloadZone() {
      try {
        const id = document.getElementById('zoneId').textContent;
        const zone = zones.find(z => String(z.id) === String(id));
        if (!zone) { alert("No game selected."); return; }
        const url = zone.url.replace("{COVER_URL}", coverURL).replace("{HTML_URL}", htmlURL);
        const res = await fetch(url + "?t=" + Date.now());
        const text = await res.text();
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = (zone.name || "game") + ".html";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      } catch (e) { alert("Download failed: " + e); console.error(e); }
    }

    function fullscreenZone() {
      if (!zoneFrame) return;
      if (zoneFrame.requestFullscreen) zoneFrame.requestFullscreen();
      else if (zoneFrame.mozRequestFullScreen) zoneFrame.mozRequestFullScreen();
      else if (zoneFrame.webkitRequestFullscreen) zoneFrame.webkitRequestFullscreen();
      else if (zoneFrame.msRequestFullscreen) zoneFrame.msRequestFullscreen();
    }

    function saveData() {
      const data = JSON.stringify(localStorage) + "\n\n|\n\n" + document.cookie;
      const blob = new Blob([data], { type: "text/plain" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${Date.now()}.data`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    function loadData(event) {
      const file = event.target.files && event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        const parts = content.split("\n\n|\n\n");
        try {
          const parsed = JSON.parse(parts[0]);
          for (let k in parsed) localStorage.setItem(k, parsed[k]);
        } catch (err) {}
        if (parts[1]) {
          const cookies = parts[1].split("; ");
          cookies.forEach(c => document.cookie = c);
        }
        alert("Data loaded");
      };
      reader.readAsText(file);
    }

    function darkMode() { document.body.classList.toggle("dark-mode"); }

    function cloakIcon(url) {
      let link = document.querySelector("link[rel~='icon']");
      if (!link) { link = document.createElement('link'); link.rel = 'icon'; document.head.appendChild(link); }
      link.href = (url && url.trim()) ? url : 'favicon.png';
    }
    function cloakName(name) { document.title = (name && name.trim()) ? name : 'gn-math'; }

    function tabCloak() {
      closePopup();
      document.getElementById('popupTitle').textContent = "Tab Cloak";
      const popupBody = document.getElementById('popupBody');
      popupBody.innerHTML = `
        <label style="font-weight:bold">Set Tab Title:</label><br>
        <input type="text" placeholder="Enter new tab name..." oninput="cloakName(this.value)"><br><br>
        <label style="font-weight:bold">Set Tab Icon (URL):</label><br>
        <input type="text" placeholder="Enter new tab icon..." oninput="cloakIcon(this.value)">
      `;
      popupBody.contentEditable = false;
      document.getElementById('popupOverlay').style.display = "flex";
    }

    // UI helpers
    document.getElementById('settings').addEventListener('click', () => {
      document.getElementById('popupTitle').textContent = "Settings";
      const popupBody = document.getElementById('popupBody');
      popupBody.innerHTML = `
        <button id="settings-button" onclick="darkMode()">Toggle Dark Mode</button><br><br>
        <button id="settings-button" onclick="tabCloak()">Tab Cloak</button>
      `;
      popupBody.contentEditable = false;
      document.getElementById('popupOverlay').style.display = "flex";
    });

    function showContact() {
      document.getElementById('popupTitle').textContent = "Contact";
      const popupBody = document.getElementById('popupBody');
      popupBody.innerHTML = `<p>Discord: https://discord.gg/NAFw4ykZ7n</p>`;
      popupBody.contentEditable = false;
      document.getElementById('popupOverlay').style.display = "flex";
    }

    function loadPrivacy() {
      document.getElementById('popupTitle').textContent = "Privacy Policy";
      const popupBody = document.getElementById('popupBody');
      popupBody.innerHTML = `<div style="max-height:60vh;overflow:auto">
        <h2>Privacy Policy</h2>
        <p>This is a local copy of the launcher. The hosted games and analytics are loaded from external CDNs; refer to the original site for the full privacy policy.</p>
      </div>`;
      popupBody.contentEditable = false;
      document.getElementById('popupOverlay').style.display = "flex";
    }

    function closePopup() { document.getElementById('popupOverlay').style.display = "none"; }

    // Hook file input
    document.getElementById('importData').addEventListener('change', loadData);

    // Start loading zones on open
    listZones();
  </script>
</body>
</html>